{% extends "layout.html" %}

{% block content %}
<h2>Settings</h2>

<!-- API Test Section -->
<div class="card p-4 mb-4">
    <h5>üîå API Connection Test</h5>
    <p class="text-muted">Manually test API connections to verify configuration.</p>

    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <strong>Azure AI</strong>
                    <span id="azureStatus" class="ms-2 badge bg-secondary">Not tested</span>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="testAzure()">
                    Test Connection
                </button>
            </div>
            <div id="azureResult" class="mt-2 small"></div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <strong>MongoDB</strong>
                    <span id="mongoStatus" class="ms-2 badge bg-secondary">Not tested</span>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="testMongo()">
                    Test Connection
                </button>
            </div>
            <div id="mongoResult" class="mt-2 small"></div>
        </div>
    </div>

    <button type="button" class="btn btn-primary" onclick="testAll()">
        üß™ Test All Connections
    </button>
</div>

<!-- Configuration Section -->
<div class="card p-4">
    <h5>‚öôÔ∏è Configuration</h5>
    <form id="settingsForm">
        <div class="mb-3">
            <label class="form-label" for="AZURE_AI_ENDPOINT">Azure AI Endpoint</label>
            <input type="text" class="form-control" name="AZURE_AI_ENDPOINT" id="AZURE_AI_ENDPOINT"
                placeholder="https://...">
        </div>
        <div class="mb-3">
            <label class="form-label" for="AZURE_AI_KEY">Azure AI Key</label>
            <input type="password" class="form-control" name="AZURE_AI_KEY" id="AZURE_AI_KEY" placeholder="Key...">
        </div>
        <div class="mb-3">
            <label class="form-label" for="MONGO_URI">MongoDB URI</label>
            <input type="password" class="form-control" name="MONGO_URI" id="MONGO_URI" placeholder="mongodb+srv://...">
        </div>
        <div class="mb-3">
            <label class="form-label" for="DISCORD_TOKEN">Discord Token</label>
            <input type="password" class="form-control" name="DISCORD_TOKEN" id="DISCORD_TOKEN" placeholder="Token...">
        </div>
        <hr>
        <h6>RAG Parameters</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label" for="RAG_THRESHOLD">Similarity Threshold</label>
                <input type="number" step="0.1" min="0" max="1" class="form-control" name="RAG_THRESHOLD"
                    id="RAG_THRESHOLD" placeholder="0.5">
                <div class="form-text">0.0-1.0 (higher = stricter)</div>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label" for="RAG_MAX_HISTORY">Max History Turns</label>
                <input type="number" min="0" max="20" class="form-control" name="RAG_MAX_HISTORY" id="RAG_MAX_HISTORY"
                    placeholder="5">
                <div class="form-text">Conversation memory</div>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label" for="RAG_TOP_K">Top K Chunks</label>
                <input type="number" min="1" max="20" class="form-control" name="RAG_TOP_K" id="RAG_TOP_K"
                    placeholder="6">
                <div class="form-text">Chunks to retrieve</div>
            </div>
        </div>
        <div class="alert alert-warning">
            ‚ö†Ô∏è <strong>Warning:</strong> Updating these settings will rewrite the <code>.env</code> file.
            You MUST restart the application manually for changes to take effect.
        </div>
        <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Configuration</button>
        <div id="statusMsg" class="mt-3"></div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadSettings() {
        try {
            const res = await fetch('/api/settings');
            const data = await res.json();
            for (const [key, value] of Object.entries(data)) {
                const input = document.getElementById(key);
                if (input) input.value = value;
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function saveSettings() {
        const form = document.getElementById('settingsForm');
        const formData = new FormData(form);
        const json = Object.fromEntries(formData.entries());

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(json)
            });
            const data = await res.json();
            const msg = document.getElementById('statusMsg');

            if (res.ok) {
                msg.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            } else {
                msg.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            }
        } catch (e) {
            alert("Failed to save settings.");
        }
    }

    async function testAzure() {
        const statusEl = document.getElementById('azureStatus');
        const resultEl = document.getElementById('azureResult');

        statusEl.className = 'ms-2 badge bg-warning';
        statusEl.textContent = 'Testing...';
        resultEl.innerHTML = '';

        try {
            const res = await fetch('/api/test/azure');
            const data = await res.json();

            if (data.success) {
                statusEl.className = 'ms-2 badge bg-success';
                statusEl.textContent = 'Success ‚úì';
                resultEl.innerHTML = `<span class="text-success">‚úì ${data.message}</span>`;
            } else {
                statusEl.className = 'ms-2 badge bg-danger';
                statusEl.textContent = 'Failed ‚úó';
                resultEl.innerHTML = `<span class="text-danger">‚úó ${data.error}</span>`;
            }
        } catch (e) {
            statusEl.className = 'ms-2 badge bg-danger';
            statusEl.textContent = 'Error';
            resultEl.innerHTML = `<span class="text-danger">‚úó Connection error: ${e.message}</span>`;
        }
    }

    async function testMongo() {
        const statusEl = document.getElementById('mongoStatus');
        const resultEl = document.getElementById('mongoResult');

        statusEl.className = 'ms-2 badge bg-warning';
        statusEl.textContent = 'Testing...';
        resultEl.innerHTML = '';

        try {
            const res = await fetch('/api/test/mongo');
            const data = await res.json();

            if (data.success) {
                statusEl.className = 'ms-2 badge bg-success';
                statusEl.textContent = 'Success ‚úì';
                resultEl.innerHTML = `<span class="text-success">‚úì ${data.message}</span>`;
            } else {
                statusEl.className = 'ms-2 badge bg-danger';
                statusEl.textContent = 'Failed ‚úó';
                resultEl.innerHTML = `<span class="text-danger">‚úó ${data.error}</span>`;
            }
        } catch (e) {
            statusEl.className = 'ms-2 badge bg-danger';
            statusEl.textContent = 'Error';
            resultEl.innerHTML = `<span class="text-danger">‚úó Connection error: ${e.message}</span>`;
        }
    }

    async function testAll() {
        await Promise.all([testAzure(), testMongo()]);
    }

    loadSettings();
</script>
{% endblock %}